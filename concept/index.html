<html>

<head>
    <title>CONCEPT!</title>
    <link rel="icon" type="image/png" href="images/14.png" />
    <link rel="stylesheet" type="text/css" href="index.css">

    <script src="../lib/jquery.min.js"></script>
    <script src="constants.js"></script>

    <script src="../lib/gsap/gsap.min.js"></script>
    <script src="../lib/gsap/Draggable.min.js"></script>

    <script>

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
        }

        const gridSize = isMobile() ? 128 : 64;

        function toggleVisibility(elementId) {
            let div = document.getElementById(elementId);
            if (div.style.display != "block")
                div.style.display = "block"
            else
                div.style.display = ""
        }

        function newWordClicked() {
            let div = document.getElementById("wordDiv");
            div.innerHTML = "Your word: \"" + words[Math.floor(Math.random() * words.length)] + "\""
            div.innerHTML = div.innerHTML.charAt(0).toUpperCase() + div.innerHTML.substring(1)
        }

        function exportClicked() {
            var copyText = document.getElementById("exportInput");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value)
        }

        function exportFocused() {
            var copyText = document.getElementById("exportInput");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
        }

        function importClicked() {
            var copyText = document.getElementById("importInput");
            saveState(copyText.value);
        }

        //
        //

        var state = []

        function getStateString() {
            let stateString = ``;
            state.forEach(e => {
                let rect = e.getBoundingClientRect();
                let x = parseInt(rect.left / gridSize)
                let y = parseInt(rect.top / gridSize)
                stateString += e.conceptIndex + "." + x + "." + y + "_"
            });
            return stateString.substring(0, stateString.length - 1)
        }

        function getUrlSearch() {
            return new URLSearchParams((new URL(window.location.href)).search)
        }

        function getUrlParam(paramName) {
            return getUrlSearch().get(paramName)
        }

        function loadState() {
            let stateString = getUrlParam('state');
            if (stateString) {
                let elemStrings = stateString.split("_")
                elemStrings.forEach(es => {
                    let elemParts = es.split(".")
                    if (elemParts.length == 3) {
                        createNode(elemParts[0], {
                            x: gridSize * elemParts[1] + gridSize / 2,
                            y: gridSize * elemParts[2] + gridSize / 2
                        }, false)
                    }
                })
            } else {

                createNode("base", {
                    x: 32 + 64 * Math.round((fullWidth() - 280) / 2 / 64),
                    y: 32 + 128
                })

            }
            updateExportInput()
        }

        function saveState(newStateString) {
            let url = getUrlSearch()
            let stateString = newStateString || getStateString()
            url.set('state', stateString)
            window.history.replaceState('', '', "?" + url.toString())
            updateExportInput()
            if (newStateString)
                window.location.href = window.location.href
        }

        function updateExportInput() {
            document.getElementById("exportInput").value = getStateString()
        }

        //
        //

        function fullWidth() {
            return Math.max(
                document.body.scrollWidth,
                document.documentElement.scrollWidth,
                document.body.offsetWidth,
                document.documentElement.offsetWidth,
                document.body.clientWidth,
                document.documentElement.clientWidth
            );
        }

        function removeNode(element) {
            document.body.removeChild(element)
            state.splice(state.indexOf(element), 1)
            saveState()
        }

        function createNode(i, event, save = true, startDrag = false) {
            var element = document.createElement('div');
            element.conceptIndex = i
            element.className = "moveable"
            element.innerHTML = `<img src="./images/${i}.png" title="${i}: ${tooltips[i]}" width="${gridSize}" height="${gridSize}">`
            element.style.top = (event.y - 32) + "px";
            element.style.left = (event.x - 32) + "px";
            if (i != "base" && isMobile()) {
                element.style.left = (fullWidth() - 280 - 128) + "px";
            }
            document.body.appendChild(element);
            let draggable = Draggable.create(element, {
                type: "left,top",
                onDragEnd: function (e) {
                    var rect = element.getBoundingClientRect();
                    let x = Math.round(rect.left / gridSize) * gridSize;
                    let y = Math.round(rect.top / gridSize) * gridSize;
                    element.style.left = x + "px";
                    element.style.top = y + "px";
                    if (x > fullWidth() - 280) {
                        if (i == "base") {
                            element.style.left = (fullWidth() - 280 - 128) + "px"
                        } else
                            removeNode(element)
                    }
                    saveState()
                },
            })[0];
            if (startDrag)
                draggable.startDrag(event)
            state.push(element)
            if (save)
                saveState()
        }

        function createButton(i) {
            var buttons = document.getElementById("buttons")
            var elemDiv = document.createElement('div');
            elemDiv.draggable = true
            elemDiv.className = "button"
            elemDiv.innerHTML = `<img src="./images/${i}.png" title="${i}: ${tooltips[i]}" width="64" height="64">`
            buttons.appendChild(elemDiv);
            elemDiv.onmousedown = e => {
                let bounds = elemDiv.getBoundingClientRect()
                createNode(i, event, true, true);
            }
        }

        function createBr(i) {
            document.getElementById("buttons").appendChild(document.createElement('br'));
        }

        let titleIndex = 0;

        function createHr(title) {
            let h1 = document.createElement('h1')
            h1.innerHTML = title
            document.getElementById("buttons").appendChild(h1);
            titleIndex++;
        }

        window.onload = () => {

            sections.forEach(section => {
                createHr(section.title)
                for (let i = section.from; i <= section.to; i++)
                    createButton(i)
            });

            loadState();

            if (!window.isSecureContext) {
                let exportInput = document.getElementById("exportInputButton");
                exportInput.parentElement.removeChild(exportInput)
            }
        }

    </script>
</head>

<body>

    <div class="ui" id="uiButtonsPanel">
        <div class="panel ui uibutton" onclick="toggleVisibility(`helpDiv`)">?</div>
        <div class="panel ui uibutton" onclick="toggleVisibility(`wordDiv`)">W</div>
        <div class="panel ui uibutton" onclick="toggleVisibility(`importDiv`)">I</div>
        <div class="panel ui uibutton" onclick="toggleVisibility(`exportDiv`)">E</div>
    </div>
    <div class="ui" id="uiPanels">
        <div class="panel hidden" id="helpDiv">
            In Concept, your goal is to guess words through the association of icons.<br />
            A player chooses a word or phrase that the other players need to guess.<br />
            The player places concepts on board.<br />
            The other players try to guess the chosen word.<br />
        </div>
        <div class="panel hidden" id="wordDiv" style="cursor: pointer;" onclick="newWordClicked()">Get a random word!</div>
        <div class="panel hidden" id="importDiv">
            To import, place your text here and click import:<br />
            <input id="importInput" type="text" style="width: 270px;">
            <button style="margin-left: 8px;" onclick="importClicked()">Import</button>
        </div>
        <div class="panel hidden" id="exportDiv">
            To export, copy this text and save it somewhere:<br />
            <input id="exportInput" type="text" style="width: 280px;" onfocus="exportFocused()">
            <button id="exportInputButton" style="margin-left: 8px;" onclick="exportClicked()">Copy</button>
        </div>
    </div>


    <div id="buttons"></div>

</body>

</html>