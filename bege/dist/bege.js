var BEGE={alphaThreshold:1,assets:{},assetsToLoad:[],loadAsset:function(assetName,assetType="image"){this.assetsToLoad.push({assetName:assetName,assetType:assetType})},currentRoom:null};function preload(){if(BEGE.assetsToLoad.length>0){BEGE.assetsToLoad.forEach(({assetName:assetName,assetType:assetType})=>{console.log("Loading asset: "+assetName);if(assetType=="image")BEGE.assets[assetName]=loadImage(`assets/${assetName}`);if(assetType=="font")BEGE.assets[assetName]=loadFont(`assets/${assetName}`)});BEGE.assetsToLoad=[]}}function setup(){let canvas=createCanvas(1024,768);canvas.style("padding-left",0);canvas.style("padding-right",0);canvas.style("margin-left","auto");canvas.style("margin-right","auto");canvas.style("display","block");if(gameStart)gameStart()}function draw(){let room=BEGE.currentRoom;if(!room)return;room.mx=mouseX;room.my=mouseY;var i=room.objects.length;while(i--){let obj=room.objects[i];if(obj.removed)room.objects.splice(i,1)}room.BEGEstep();noSmooth();if(room.backgroundColor)background(room.backgroundColor);room.BEGEdraw({mx:room.mx,my:room.my})}function mousePressed(event){let room=BEGE.currentRoom;if(!room)return;let mx=mouseX;let my=mouseY;if(room.onMousePressed){if(room.onMousePressed({mx:mx,my:my,...event}))return}room.objects.every(obj=>{if(isPointInsideObject(mx,my,obj)){obj.isMousePressed=true;if(obj.onMousePressed)if(obj.onMousePressed.call(obj,{mx:mx,my:my,...event}))return false}return true})}function mouseReleased(event){let room=BEGE.currentRoom;if(!room)return;let mx=mouseX;let my=mouseY;let handled=false;if(room.onMouseReleased){handled=handled||room.onMouseReleased({mx:mx,my:my,...event})}room.objects.forEach(obj=>{if(obj.sprite&&obj.onMouseReleased&&obj.sprite.width&&obj.sprite.height&&mx>obj.x&&my>obj.y&&mx<obj.x+obj.sprite.width&&my<obj.y+obj.sprite.height){if(!handled)handled=handled||obj.onMouseReleased.call(obj,{mx:mx,my:my,...event})}obj.isMousePressed=false})}function ninePatch(assetName,x,y,width,height){let img=BEGE.assets[assetName];if(!img)console.log(`ERROR: image <${imageSrc}> not present. Load it with BEGE.loadAsset("image_name.png")`);let patchWidth=img.width/3;let patchHeight=img.height/3;for(let dx=patchWidth;dx<width-patchWidth;dx+=patchWidth){for(let dy=patchHeight;dy<height-patchHeight;dy+=patchHeight){image(img,x+dx,y+dy,patchWidth,patchHeight,patchWidth,patchHeight,patchWidth,patchHeight)}}[[0,0],[height-patchHeight,patchHeight*2]].forEach(([dy,srcDy])=>{let dx=patchWidth;for(;dx<width-patchWidth*2;dx+=patchWidth){image(img,x+dx,y+dy,patchWidth,patchHeight,patchWidth,srcDy,patchWidth,patchHeight)}if(width>patchWidth*2)image(img,x+width-patchWidth*2,y+dy,patchWidth,patchHeight,patchWidth,srcDy,patchWidth,patchHeight)});[[0,0],[width-patchWidth,patchWidth*2]].forEach(([dx,srcDx])=>{let dy=patchHeight;for(;dy<height-patchHeight*2;dy+=patchHeight){image(img,x+dx,y+dy,patchWidth,patchHeight,srcDx,patchHeight,patchWidth,patchHeight)}if(height>patchHeight*2)image(img,x+dx,y+height-patchHeight*2,patchWidth,patchHeight,srcDx,patchHeight,patchWidth,patchHeight)});image(img,x,y,patchWidth,patchHeight,0,0,patchWidth,patchHeight);image(img,x+width-patchWidth,y,patchWidth,patchHeight,patchWidth*2,0,patchWidth,patchHeight);image(img,x,y+height-patchHeight,patchWidth,patchHeight,0,patchHeight*2,patchWidth,patchHeight);image(img,x+width-patchWidth,y+height-patchHeight,patchWidth,patchHeight,patchWidth*2,patchHeight*2,patchWidth,patchHeight)}class BegeObject{x=0;y=0;z=0;removed=false;mouseIsPressed=false;constructor(x,y){this.x=x;this.y=y}BEGEstep(){if(this.preStep)this.preStep();if(this.vx)this.x+=this.vx;if(this.vy)this.y+=this.vy;if(this.step)this.step.call(this)}BEGEdraw(event){if(this.sprite)this.sprite.BEGEdraw(this.x,this.y,event);if(this.draw)this.draw(this.x,this.y,event)}remove(){this.removed=true}}class BegeButton extends BegeObject{action;constructor(x,y,width,height,imageSrc,action){super(x,y);this.action=action;this.sprite=new BegeSprite(imageSrc,width,height)}onMouseReleased(){this.action()}}class BegeRoom{objects;mx=-1e4;my=-1e4;constructor(){this.objects=[]}BEGEstep(){if(this.step)this.step();this.objects.forEach(obj=>{if(obj.onHover){if(isPointInsideObject(this.mx,this.my,obj)){obj.isHovered=true;if(typeof obj.onHover==="function")obj.onHover.call(obj,this.mx,this.my)}else{obj.isHovered=false}}obj.BEGEstep()})}BEGEdraw(event){if(this.predraw)this.predraw(event);this.objects.sort((a,b)=>a.z-b.z);for(let i=this.objects.length-1;i>=0;i--)this.objects[i].BEGEdraw(event);if(this.draw)this.draw(event)}addObject(obj){obj.room=this;this.objects.push(obj);return obj}}class BegeSprite{imageSrc;width;height;srcBounds;imageSpeed=30;BEGEpixelsAreLoaded=false;constructor(imageSrc,width,height,srcBounds){this.imageSrc=imageSrc;this.width=width;this.height=height;this.srcBounds=srcBounds;if(!this.srcBounds)this.srcBounds={};if(!this.srcBounds.x)this.srcBounds.x=0;if(!this.srcBounds.y)this.srcBounds.y=0;if(!this.srcBounds.width)this.srcBounds.width=width;if(!this.srcBounds.height)this.srcBounds.height=height}BEGEdraw(x,y){if(this.imageSrc===null)return;let image=BEGE.assets[this.imageSrc];if(!image)console.log(`ERROR: image <${imageSrc}> not present. Load it with BEGE.loadAsset("image_name.png")`);if(this.imageIndex){}else{this.BEGEdrawImage(image,x,y)}if(this.draw){this.draw(x,y)}}BEGEdrawImage(img,x,y){image(img,x,y,this.width,this.height,this.srcBounds.x,this.srcBounds.y,this.srcBounds.width,this.srcBounds.height)}}class BegeTileset{imageSrc;tiles;constructor(imageSrc){this.imageSrc=imageSrc;this.tiles={}}addTiles(name,x,y,width,height,cols,rows){for(let c=0;c<cols;c++){for(let r=0;r<rows;r++){let id=c+r*cols;this.tiles[name+id]={x:x+c*width,y:y+r*height,width:width,height:height}}}}drawTile(id,x=0,y=0,width=null,height=null){let img=BEGE.assets[this.imageSrc];if(!img)console.log(`BEGE-ERROR: image <${imageSrc}> not present! Load it with BEGE.loadAsset("image_name.png")`);let tileSrc=this.tiles[id];image(img,x,y,width?width:tileSrc.width,height?height:tileSrc.height,tileSrc.x,tileSrc.y,tileSrc.width,tileSrc.height)}}function isPointInsideObject(x,y,obj){if(!obj.sprite)return false;if(x>=obj.x&&y>=obj.y&&x<obj.x+obj.sprite.width&&y<obj.y+obj.sprite.height){if(obj.sprite.imageSrc===null)return true;let img=BEGE.assets[obj.sprite.imageSrc];let sprite=obj.sprite;let bounds=sprite.srcBounds;if(!obj.sprite.BEGEpixelsAreLoaded){obj.sprite.pixels=img.loadPixels();obj.sprite.BEGEpixelsAreLoaded=true}let rw=bounds.width/sprite.width;let rh=bounds.height/sprite.height;let index=4*(img.width*(bounds.y+Math.floor((y-obj.y)*rh))+(bounds.x+Math.floor((x-obj.x)*rw)));return img.pixels[index+3]>BEGE.alphaThreshold}return false}
